---
title: Dockerè¿œç¨‹è¿æ¥å¹¶å®ç°å®‰å…¨çš„é€šä¿¡
date: 2022-07-15 17:55:58
tags: 
    - Docker
categories: äº‘åŸç”Ÿ
---

Docker ä½¿ç”¨äº†å®¢æˆ·ç«¯ -- æœåŠ¡ç«¯æ¨¡å‹ã€‚æœåŠ¡ç«¯å¯¹å¤–æä¾› REST APIã€‚

é»˜è®¤å®‰è£…æ–¹å¼ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨åŒä¸€å°ä¸»æœºä¸Šï¼Œé€šè¿‡æœ¬åœ°å®‰å…¨ PIC Socket è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚ Linux ä¸­ /var/run/docker.sockã€‚æˆ‘ä»¬è¿˜å¯ä»¥é…ç½®å®ƒä»¬é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚å®ƒä»¬é»˜è®¤ç½‘ç»œé…ç½®ä½¿ç”¨ä¸å®‰å…¨çš„ HTTP Socketï¼Œç«¯å£ä¸º 2375ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒè¿™æ˜¯ä¸èƒ½æ¥å—çš„ã€‚é€šè¿‡ TLS çš„æ–¹å¼è¿æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç”Ÿäº§ç¯å¢ƒä¸­æ¨èè¿™ç§é…ç½®ï¼Œå³ä½¿åœ¨å¯ä¿¡å†…ç½‘ä¸­ï¼Œä¹Ÿå»ºè®®ä½¿ç”¨è¯¥æ–¹å¼ï¼

Docker ä¸º TLS æä¾›äº†ä¸¤ç§æ¨¡å¼ã€‚

- daemon æ¨¡å¼ï¼šDocker daemon åªæ¥æ”¶è®¤è¯å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚
- å®¢æˆ·ç«¯æ¨¡å¼ï¼šDocker å®¢æˆ·ç«¯åªæ¥æ”¶è®¤è¯çš„ daemon å‘èµ·çš„è¯·æ±‚ã€‚

åŒæ—¶ä½¿ç”¨å®ƒä»¬ï¼Œèƒ½æä¾›æœ€é«˜çš„å®‰å…¨ç­‰çº§ã€‚

ä¸‹é¢å¼€å§‹ä»‹ç»å¦‚ä½•å®Œæˆ TLS çš„é…ç½®ï¼Œæ€»ä½“æ­¥éª¤å¦‚ä¸‹ã€‚
- åˆ›å»º CA ã€‚
- ä¸º daemon åˆ›å»ºå¯†é’¥å¯¹ã€‚
- ä¸ºå®¢æˆ·ç«¯åˆ›å»ºå¯†é’¥å¯¹ã€‚
- åˆ†å‘å¯†é’¥
- Docker é…ç½® TLS æ¨¡å¼ 

![_ç¤ºä¾‹ç¯å¢ƒ_](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52f833c4b69c4f638ab983463f8ff364~tplv-k3u1fbpfcp-watermark.image?)_ç¤ºä¾‹ç¯å¢ƒ_

## åˆ›å»º CA
åœ¨ node2 è¿è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚
1. ä¸º CA åˆ›å»ºç§é’¥ï¼ˆè¿‡ç¨‹ä¸­éœ€è¦è®¾ç½®å¯†ç ï¼‰
`$ openssl genrsa -aes256 -out ca-key.pem 4096`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª ca-key.pem æ–‡ä»¶ï¼Œè¿™æ˜¯ CA ç§é’¥ã€‚

2. ç”¨ CA ç§é’¥ç”Ÿæˆå…¬é’¥ï¼ˆè¿‡ç¨‹éœ€è¦è¾“å…¥ä¹‹å‰çš„å¯†ç ï¼‰
`$ openssl req -new -x509 -days 730 -key ca-key.pem -sha256 -out ca.pem`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª ca.pem æ–‡ä»¶ï¼Œè¿™æ˜¯ CA å…¬é’¥ï¼Œä¹Ÿå«â€è¯ä¹¦â€œã€‚

## ä¸º daemon åˆ›å»ºå¯†é’¥å¯¹
åœ¨ node3 è¿è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚
1. ä¸º daemon åˆ›å»ºç§é’¥ã€‚
`$ openssl genrsa -out daemon-key.pem 4096`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª daemon-key.pem æ–‡ä»¶ï¼Œè¿™æ˜¯ daemon èŠ‚ç‚¹çš„ç§é’¥ã€‚

2. åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚å¹¶å‘é€åˆ° CAã€‚
`$ openssl req -subj "/CN=daemon" \
  -sha256 -new -key daemon-key.pem -out daemon.csr`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª daemon.csr æ–‡ä»¶ï¼Œè¿™æ˜¯ CSRã€‚

3. ä¸ºè¯ä¹¦æ·»åŠ å±æ€§ã€‚
åˆ›å»ºæ–‡ä»¶ï¼Œåä¸º extfile.cnfã€‚ç¤ºä¾‹ä¸­ä½¿ç”¨äº† daemon èŠ‚ç‚¹çš„ DNS åç§°å’Œ IPã€‚æ¯ä¸ªäººçš„ç¯å¢ƒä¸­å¯èƒ½å€¼ä¸åŒã€‚
```
$ subjectAltName = DNS:daemon,IP:192.168.57.3
extendedKeyUsage = serverAuth
```

4. ç”Ÿæˆè¯ä¹¦
ä½¿ç”¨ CSR æ–‡ä»¶ã€CA å¯†é’¥ã€extfile.cnf æ–‡ä»¶å®Œæˆç­¾åå’Œ daemon è¯ä¹¦é…ç½®ã€‚
`$ openssl x509 -req -days 730 -sha256 \
  -in daemon.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out daemon-cert.pem -extfile extfile.cnf
`

æ­¤æ—¶ï¼Œå·²ç»æ‹¥æœ‰ä¸€ä¸ªå¯ç”¨ CA ï¼ŒåŒæ—¶ daemon çš„ Node3 èŠ‚ç‚¹ä¹Ÿæœ‰äº†è‡ªå·±çš„å¯†é’¥ã€‚

ç»§ç»­ä¸‹é¢å†…å®¹å‰ï¼Œåˆ é™¤ CSR å’Œ extfile.cnfã€‚
`$ rm daemon.csr extfile.cnf`

## ä¸ºå®¢æˆ·ç«¯åˆ›å»ºå¯†é’¥å¯¹
åœ¨ node3 è¿è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚

1. ä¸ºå®¢æˆ·ç«¯åˆ›å»ºå¯†é’¥
`$ openssl genrsa -out client-key.pem 4096`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª client-key.pem æ–‡ä»¶ã€‚

2. åˆ›å»º CSRã€‚
`$ openssl req -subj '/CN=client' -new -key client-key.pem -out client.csr`
å½“å‰ç›®å½•æ–°å¢ä¸€ä¸ª client.csr æ–‡ä»¶ã€‚

3. åˆ›å»º extfile.cnf æ–‡ä»¶
å°†è¯ä¹¦è®¾ç½®ä¸ºå®¢æˆ·ç«¯è®¤è¯å¯ç”¨ã€‚æ–‡ä»¶å†…å®¹å¦‚ä¸‹ã€‚
`extendedKeyUsage = clientAuth`

4. ç”Ÿæˆè¯ä¹¦
ä½¿ç”¨ CSR æ–‡ä»¶ã€CA å¯†é’¥ã€extfile.cnf æ–‡ä»¶å®Œæˆç­¾åå’Œå®¢æˆ·ç«¯è¯ä¹¦é…ç½®ã€‚
`$ openssl x509 -req -days 730 -sha256 \
  -in client.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out client-cert.pem -extfile extfile.cnf`

åˆ é™¤ CSR å’Œ extfile.cnf ï¼Œå› ä¸ºä¸ä¼šç”¨åˆ°å®ƒä»¬äº†ã€‚
`$ rm client.csr extfile.cnf`

æ­¤æ—¶ï¼Œåœ¨å·¥ä½œç›®å½•ä¸‹åº”è¯¥æœ‰å¦‚ä¸‹ 7 ä¸ªæ–‡ä»¶ã€‚
```
ca-key.pem
ca.pem
ca.srl
client-cert.pem
client-key.pem
daemon-cert.pem
daemon-key.pem
```

## åˆ†å‘å¯†é’¥
- ä» CA (åˆšæ‰è¯ä¹¦ç”Ÿæˆçš„ node) å¤åˆ¶ ca.pemã€daemon-cert.pemã€daemon-key.pem åˆ° node3ï¼ˆdaemon èŠ‚ç‚¹ï¼‰ã€‚
- ä» CA (åˆšæ‰è¯ä¹¦ç”Ÿæˆçš„ node) å¤åˆ¶ ca.pemã€client-cert.pemã€client-key.pem åˆ° node1ï¼ˆå®¢æˆ·ç«¯èŠ‚ç‚¹ï¼‰ã€‚

è¿™é‡Œç”¨ scp å®Œæˆå¤åˆ¶æ“ä½œã€‚åœ¨ scp çš„è¿‡ç¨‹ä¸­å¯¹éƒ¨åˆ†æ–‡ä»¶è¿›è¡Œäº†é‡å‘½åã€‚**é‡å‘½åéå¸¸é‡è¦**ï¼Œå› ä¸º Docker å¯¹æ–‡ä»¶å‘½åæœ‰è§„èŒƒã€‚
```
// Daemon files
$ scp ./ca.pem ubuntu@daemon:/home/ubuntu/.docker/ca.pem
$ scp ./daemon-cert.pem ubuntu@daemon:/home/ubuntu/.docker/cert.pem
$ scp ./daemon-key.pem ubuntu@daemon:/home/ubuntu/.docker/key.pem

// Client files
$ scp ./ca.pem ubuntu@client:/home/ubuntu/.docker/ca.pem
$ scp ./client-cert.pem ubuntu@client:/home/ubuntu/.docker/cert.pem
$ scp ./client-key.pem ubuntu@client:/home/ubuntu/.docker/key.pem
```

## Docker é…ç½® TLS æ¨¡å¼ 
è¿›å…¥ Node3ï¼ˆdaemon èŠ‚ç‚¹ï¼‰å®Œæˆä¸‹é¢çš„é…ç½®ã€‚

æ‰¾åˆ° daemon.json é…ç½®æ–‡ä»¶ã€‚åœ¨ Linux ä¸Šä½äº /etc/dockerï¼Œç¼–è¾‘ daemon.json æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹è¡Œã€‚
```
   "tls": true, 
   "tlsverify": true,
   "tlscacert": "/home/ubuntu/.docker/ca.pem",
   "tlscert": "/home/ubuntu/.docker/cert.pem",
   "tlskey": "/home/ubuntu/.docker/key.pem",
   "hosts": ["tcp://ä½ çš„ daemon çš„IP:2376"]
```

è¿™äº› daemon.json ä¸­çš„å‚æ•°æ„ä¹‰å¦‚ä¸‹ã€‚
- tlsverify ï¼šå¼€å¯ TLS è®¤è¯ã€‚
- tlscacert ï¼šæŒ‡å®šdaemonå¯ä¿¡ä»»çš„ CAã€‚
- tlscert ï¼šå‘ Docker æŒ‡å®š daemon è¯ä¹¦çš„ä½ç½®ã€‚
- tlskey ï¼šå‘ Docker æŒ‡å®šdaemonç§é’¥çš„ä½ç½®ã€‚
- hosts ï¼šå‘ Docker æŒ‡å®šéœ€è¦ç»‘å®š daemon çš„å…·ä½“ Socketã€‚

<div class="warning">

> éƒ¨åˆ†ç‰ˆæœ¬çš„ Linux ç³»ç»Ÿè¿è¡Œ systemd çš„ï¼Œä¸å…è®¸åœ¨ daemon.json ä¸­ä½¿ç”¨â€œhostsâ€é€‰é¡¹ã€‚æ›¿æ¢æ–¹æ¡ˆæ˜¯åœ¨ systemd é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé‡å†™ã€‚åˆ›å»ºåä¸º /etc/systemd/system/docker.service.d/override.conf çš„æ–°æ–‡ä»¶ã€‚åœ¨å…¶ä¸­åŠ å…¥ä¸‹åˆ— 3 è¡Œå†…å®¹ï¼Œç„¶åä¿å­˜ã€‚
> ```
> [Service]
> ExecStart=
> ExecStart=/usr/bin/dockerd -H tcp://ä½ çš„ daemon çš„IP:2376â€
> ```

</div>

é‡å¯ daemon ã€‚
`$ systemctl daemon-reload`
`$ systemctl restart docker.service`

<div class="warning">

> å¦‚æœé‡å¯å¤±è´¥ä¸”é”™è¯¯ä¸º `docker.service: Main process exited, code=exited, status=1/FAILURE`
> 
> ä¸ºäº†è®©å®ƒå·¥ä½œï¼Œç¼–è¾‘ `/lib/systemd/system/docker.service`ï¼Œä¿®æ”¹å¦‚ä¸‹å†…å®¹ä¹‹åå†æ¬¡å°è¯•é‡å¯ã€‚
> ```
> # ä¿®æ”¹å‰:
> ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
> 
> # ä¿®æ”¹å:
> ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock
> ```

</div>

ç†è®ºä¸Šï¼Œ`/etc/systemd/system/docker.service.d/override.conf` ä¸ `/etc/docker/daemon.json` å¯ä»¥åŒæ—¶ä¿®æ”¹ï¼Œä½†æ˜¯å¹¶ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå¦‚æœä»…ä¿®æ”¹ `/etc/docker/daemon.json` æ²¡æœ‰å‡ºç°ä»»ä½•é—®é¢˜ï¼Œé‚£å°±å¤ªæ£’äº†ã€‚

è¿›å…¥ Docker å®¢æˆ·ç«¯èŠ‚ç‚¹ï¼Œé…ç½®ä¸´æ—¶ç¯å¢ƒå˜é‡ã€‚
`$ export DOCKER_HOST=tcp://ä½ çš„ daemon IP åœ°å€:2376`

å°è¯•è¿è¡Œ `$ docker version`ï¼Œä¼šå‡ºç°é”™è¯¯ï¼Œç±»ä¼¼æ— æ³•è¿æ¥ daemonã€‚æ¥ç€è®¾ç½®å¦ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚

`$ export DOCKER_TLS_VERIFY=1`

å®ƒæ˜¯å‘ŠçŸ¥ Docker å®¢æˆ·ç«¯ä½¿ç”¨è¯ä¹¦å¯¹å…¨éƒ¨å‘½ä»¤è¿›è¡Œç­¾åï¼Œæ­¤æ—¶å†è¯•è¯• `$ docker version`ï¼

ğŸ‰ æ­å–œã€‚ä½ æˆåŠŸå®Œæˆäº†å®¢æˆ·ç«¯ä¸ daemon å®Œæˆå®‰å…¨çš„é€šä¿¡ã€‚