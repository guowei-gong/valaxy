---
title: æŠ–éŸ³æ— æ°´å°è§†é¢‘è§£æåŠä»£ç å®ç°
date: 2021-02-13 22:05:01
categories:
    - æ— å¤„å®‰æ”¾
tags: 
    - PHP
---

æœ¬æ–‡çš„ç›®æ ‡æ˜¯æä¾›æ€è·¯ï¼Œä»å®ç”¨çš„è§‚ç‚¹æ¥çœ‹ï¼Œè¿™å°†æä¾›ä¸€ä¸ªæˆæœ¬ç›¸å¯¹è¾ƒä½çš„è§£å†³æ–¹æ¡ˆã€‚åŒæ—¶æˆ‘ä¹Ÿä¼šé•¿æ—¶é—´æä¾›å¯è¿è¡Œçš„æ— æ°´å°è§†é¢‘ä¸‹è½½[å¼€æºä»£ç ](https://github.com/haxifang-aircos/tiktok-parse)ã€‚

## ğŸ”­ é¢„æœŸ

![å¤„ç†å‰](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8288369f01ff4ee2863eeffaa260b341~tplv-k3u1fbpfcp-zoom-1.image)


![å¤„ç†å](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2b2d8333a5748dba7deccb744fc32ef~tplv-k3u1fbpfcp-zoom-1.image)

## ğŸ’» æ­£æ–‡
- **æ–¹æ³•ä¸€ï¼šä½¿ç”¨å»æ°´å°å¹³å°**
  - https://ssstik.io
  - http://douyin.iiilab.com/
  
  è¿™äº›ç½‘ç«™æ˜¯é’ˆå¯¹çŸ­è§†é¢‘å¹³å°çš„ï¼Œä½†éœ€è¦ä»˜è´¹è§£æçš„ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ [Splinter](http://splinter.readthedocs.io/en/latest/)ã€‚ å°†æµè§ˆå™¨è®¾ç½®ä¸ºæ— å¤´æµè§ˆå™¨ ï¼Œç›´æ¥æ¨¡æ‹Ÿè¯·æ±‚è§£æï¼Œå¯ä»¥ç™½å«–ã€‚
  
- **æ–¹æ³•äºŒï¼šç›´æ¥ä¿®æ”¹ä¸‹è½½é“¾æ¥** 
```php
  public function main() {
      // è§†é¢‘æ’­æ”¾åœ°å€, é€šè¿‡æŠ–éŸ³åˆ†äº«é“¾æ¥è·å–
      $url = 'https://v.douyin.com/JKgS4Vp/'
      $url = $this->getCurl($url);

      preg_match('/video\/([0-9]+)\//i', $url, $matches);

      $result = $this->video_url($matches[1]);
      return $result;
  }
  
    /**
    * è·å–æŠ–éŸ³æ¥å£è§†é¢‘ä¿¡æ¯
    */
    private function video_url($dyid)
    {
        $getApi = 'https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=' . $dyid;
        $data = $this->getCurl($getApi);
        $json = json_decode($data, true);
        //è§†é¢‘æè¿°
        $playUrl = null;
        foreach ($json['item_list'] as $k => $v) {
            //æ— æ°´å°URL
            $playUrl = $list['play_url'] = $this->Url($v['video']['play_addr']['url_list']);
        }
        return [
           'play_url' => urldecode($playUrl),
        ];
    }
  
  /**
  * ä¿®æ”¹ä¸‹è½½é“¾æ¥
  */
  public function Url($list) {
    return $list[0].replace('playwm','play')
  }
  
  /**
  * å‘èµ·è¯·æ±‚
  */
  public function getCurl($url, $options = [], $foll = 0)
  {
      //åˆå§‹åŒ–
      $ch = curl_init();
      curl_setopt($ch, CURLOPT_URL, $url); //è®¿é—®çš„url
      curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); //å®Œå…¨é™é»˜
      curl_setopt($ch, CURLOPT_HEADER, false);
      curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); //å¿½ç•¥https
      curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false); //å¿½ç•¥https
      curl_setopt($ch, CURLOPT_HTTPHEADER, array_merge([self::getRandomUserAgent()], $options)); //UA
      curl_setopt($ch, CURLOPT_FOLLOWLOCATION, $foll); //é»˜è®¤ä¸º$foll=0,å¤§æ¦‚æ„æ€å°±æ˜¯å¯¹ç…§æ¨¡å—ç½‘é¡µè®¿é—®çš„ç¦æ­¢301 302 è·³è½¬ã€‚
      $output = curl_exec($ch); //è·å–å†…å®¹
      curl_close($ch); //å…³é—­
      return $output; //è¿”å›
  }
```
  

- **æ–¹æ³•ä¸‰ï¼šè®¾ç½®è§†é¢‘æ’­æ”¾åœ°å€çš„ Referer ä¸ Host**
```php
    public function main() {
        // è§†é¢‘æ’­æ”¾åœ°å€, é€šè¿‡æŠ–éŸ³åˆ†äº«é“¾æ¥è·å–
        $url = 'https://v.douyin.com/JKgS4Vp/'
        $url = $this->getCurl($url);

        preg_match('/video\/([0-9]+)\//i', $url, $matches);
        
        $result = $this->videoUrl($matches[1]);
        return $result;
    }
    
    /**
    * è·å–æŠ–éŸ³æ¥å£è§†é¢‘ä¿¡æ¯
    */
    private function videoUrl($dyid)
    {
        $getApi = 'https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=' . $dyid;
        $data = $this->getCurl($getApi);
        $json = json_decode($data, true);
        //è§†é¢‘æè¿°
        $playUrl = null;
        foreach ($json['item_list'] as $k => $v) {
            //æ— æ°´å°URL
            $playUrl = $list['play_url'] = $this->Url($v['video']['play_addr']['uri']);
        }
        return [
           'play_url' => urldecode($playUrl),
        ];
    }

    /**
    * è·å–é‡å®šå‘è§†é¢‘åœ°å€
    */
    public function Url($videoId)
    {
        $str = $this->getCurl("https://aweme.snssdk.com/aweme/v1/play/?video_id=" . $videoId . "&line=0", [
            'Referer' => "https://www.iesdouyin.com",
            'Host' => "www.iesdouyin.com",
        ], 0);
        preg_match('#<a href="(.*?)">#', $str, $data);
        $download_url = explode("//", $data[1]);
        return isset($download_url[1]) ? 'https://' . $download_url[1] : 'è§£æå¤±è´¥';
    }
    
    /**
    * å‘èµ·è¯·æ±‚
    */
    public function getCurl($url, $options = [], $foll = 0)
    {
        //åˆå§‹åŒ–
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url); //è®¿é—®çš„url
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); //å®Œå…¨é™é»˜
        curl_setopt($ch, CURLOPT_HEADER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); //å¿½ç•¥https
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false); //å¿½ç•¥https
        curl_setopt($ch, CURLOPT_HTTPHEADER, array_merge([self::getRandomUserAgent()], $options)); //UA
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, $foll); //é»˜è®¤ä¸º$foll=0,å¤§æ¦‚æ„æ€å°±æ˜¯å¯¹ç…§æ¨¡å—ç½‘é¡µè®¿é—®çš„ç¦æ­¢301 302 è·³è½¬ã€‚
        $output = curl_exec($ch); //è·å–å†…å®¹
        curl_close($ch); //å…³é—­
        return $output; //è¿”å›
    }   
```

## ğŸ‰ æ€»ç»“
è·å–æŠ–éŸ³æ— æ°´å°è§†é¢‘ï¼Œæ‰“å¼€æŠ“åŒ…å·¥å…·å°±èƒ½æ‰¾åˆ°è§„å¾‹ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ä¼šç•™åˆ°æœ€åã€‚ç›®å‰æˆ‘æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯å…ˆå» github ä¸Šæ£€ç´¢å…³é”®è¯ï¼Œå­¦ä¹ åŒè¡Œçš„æ€è·¯ã€‚github ä¸­ä¸€èˆ¬å¯ä»¥æ€»ç»“å‡º 2 ~ 3 ç§æ–¹æ¡ˆï¼Œå†æ ¹æ®è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼Œé€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆã€‚<br/>